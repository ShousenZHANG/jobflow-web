"use client";

import { useEffect, useLayoutEffect, useMemo, useRef, useState, useTransition } from "react";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";
import rehypeHighlight from "rehype-highlight";
import "highlight.js/styles/github.css";
import "react-day-picker/dist/style.css";
import { Copy, Download, ExternalLink, FileText, MapPin, Search, Trash2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Pagination, PaginationContent, PaginationItem, PaginationNext, PaginationPrevious } from "@/components/ui/pagination";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Skeleton } from "@/components/ui/skeleton";
import { Dialog, DialogClose, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Textarea } from "@/components/ui/textarea";
import { useToast } from "@/hooks/use-toast";
import { useDebouncedValue } from "@/hooks/useDebouncedValue";
import { useGuide } from "@/app/GuideContext";
import { useFetchStatus, type FetchRunStatus } from "@/app/FetchStatusContext";
import { type JobFitApiResponse, type JobFitGateStatus } from "@/lib/shared/jobFitAnalysis";

type JobStatus = "NEW" | "APPLIED" | "REJECTED";

type JobItem = {
  id: string;
  jobUrl: string;
  title: string;
  company: string | null;
  location: string | null;
  jobType: string | null;
  jobLevel: string | null;
  status: JobStatus;
  resumePdfUrl?: string | null;
  resumePdfName?: string | null;
  createdAt: string;
  updatedAt: string;
};

type JobsResponse = {
  items: JobItem[];
  nextCursor: string | null;
  totalCount?: number;
  facets?: {
    jobLevels?: string[];
  };
};

function fitGateClass(status: JobFitGateStatus) {
  if (status === "PASS") return "bg-emerald-100 text-emerald-700";
  if (status === "BLOCK") return "bg-rose-100 text-rose-700";
  return "bg-amber-100 text-amber-800";
}

function formatAiReason(reason?: string | null) {
  if (!reason) return "";
  if (reason === "GEMINI_API_KEY_MISSING") return "Gemini API key is not configured.";
  if (reason === "GEMINI_REQUEST_FAILED") return "Gemini request failed; using rule-based result.";
  if (reason === "GEMINI_INVALID_JSON") return "Gemini returned invalid JSON; using rule-based result.";
  if (reason === "NO_JD") return "Job description is not available yet.";
  if (reason === "NOT_COMPUTED") return "Analysis has not run yet.";
  if (reason === "ANALYSIS_FAILED") return "Analysis fallback was used due to an internal error.";
  return reason;
}

type CvSource = "ai" | "base" | "manual_import";
type CoverSource = "ai" | "fallback" | "manual_import";
type ResumeImportOutput = {
  cvSummary: string;
};

type CoverImportOutput = {
  cover: {
    subject?: string;
    date?: string;
    salutation?: string;
    paragraphOne: string;
    paragraphTwo: string;
    paragraphThree: string;
    closing?: string;
    signatureName?: string;
  };
};

type ExternalPromptMeta = {
  ruleSetId: string;
  resumeSnapshotUpdatedAt: string;
};

const SKILL_PACK_META_STORAGE_KEY = "jobflow.skill-pack-meta.v1";

function isValidPromptMeta(value: unknown): value is ExternalPromptMeta {
  if (!value || typeof value !== "object") return false;
  const record = value as Record<string, unknown>;
  return (
    typeof record.ruleSetId === "string" &&
    record.ruleSetId.length > 0 &&
    typeof record.resumeSnapshotUpdatedAt === "string" &&
    record.resumeSnapshotUpdatedAt.length > 0
  );
}

function readSavedSkillPackMeta(): ExternalPromptMeta | null {
  if (typeof window === "undefined") return null;
  const raw = window.localStorage.getItem(SKILL_PACK_META_STORAGE_KEY);
  if (!raw) return null;
  try {
    const parsed = JSON.parse(raw) as unknown;
    return isValidPromptMeta(parsed) ? parsed : null;
  } catch {
    return null;
  }
}

function writeSavedSkillPackMeta(meta: ExternalPromptMeta) {
  if (typeof window === "undefined") return;
  window.localStorage.setItem(SKILL_PACK_META_STORAGE_KEY, JSON.stringify(meta));
}

function isSkillPackFresh(required: ExternalPromptMeta | null): boolean {
  if (!required) return false;
  const saved = readSavedSkillPackMeta();
  return (
    !!saved &&
    saved.ruleSetId === required.ruleSetId &&
    saved.resumeSnapshotUpdatedAt === required.resumeSnapshotUpdatedAt
  );
}

const HIGHLIGHT_KEYWORDS = [
  "HTML",
  "CSS",
  "Sass",
  "SCSS",
  "Less",
  "JavaScript",
  "TypeScript",
  "React",
  "Next.js",
  "Vue",
  "Nuxt",
  "Angular",
  "Svelte",
  "SvelteKit",
  "SolidJS",
  "Remix",
  "Node",
  "Node.js",
  "Express",
  "NestJS",
  "Fastify",
  "Deno",
  "Bun",
  "Python",
  "Django",
  "Flask",
  "FastAPI",
  "Java",
  "Spring",
  "Spring Boot",
  "Kotlin",
  "Scala",
  "C#",
  ".NET",
  "ASP.NET",
  "C++",
  "Go",
  "Golang",
  "Rust",
  "Ruby",
  "Rails",
  "PHP",
  "Laravel",
  "GraphQL",
  "REST",
  "gRPC",
  "tRPC",
  "SQL",
  "PostgreSQL",
  "MySQL",
  "SQLite",
  "MongoDB",
  "Redis",
  "Elasticsearch",
  "OpenSearch",
  "Kafka",
  "RabbitMQ",
  "SQS",
  "SNS",
  "AWS",
  "Azure",
  "GCP",
  "Firebase",
  "Cloudflare",
  "Docker",
  "Kubernetes",
  "Terraform",
  "Ansible",
  "Git",
  "GitHub Actions",
  "GitLab CI",
  "CI/CD",
  "Linux",
  "Nginx",
  "Vercel",
  "Netlify",
  "Jest",
  "Vitest",
  "Cypress",
  "Playwright",
  "Storybook",
  "Tailwind",
  "shadcn/ui",
  "Material UI",
  "Chakra UI",
  "Figma",
  "React Native",
  "Flutter",
  "Swift",
  "SwiftUI",
  "Android",
  "iOS",
  "ML",
  "AI",
  "LLM",
  "OpenAI",
  "LangChain",
  "Vector",
  "Pinecone",
  "Weaviate",
  "Snowflake",
  "Databricks",
  "Airflow",
  "dbt",
];

const LOCATION_OPTIONS = [
  { value: "New South Wales, Australia", label: "New South Wales" },
  { value: "Victoria, Australia", label: "Victoria" },
  { value: "Queensland, Australia", label: "Queensland" },
  { value: "Western Australia, Australia", label: "Western Australia" },
  { value: "South Australia, Australia", label: "South Australia" },
  { value: "Australian Capital Territory, Australia", label: "ACT" },
  { value: "Tasmania, Australia", label: "Tasmania" },
  { value: "Northern Territory, Australia", label: "Northern Territory" },
];

function escapeRegExp(value: string) {
  return value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function formatInsertedTime(iso: string) {
  const createdAt = new Date(iso);
  if (Number.isNaN(createdAt.getTime())) return "unknown";
  const diffMs = Date.now() - createdAt.getTime();
  const diffMinutes = Math.max(1, Math.floor(diffMs / 60000));
  if (diffMinutes < 60) return `${diffMinutes} min ago`;
  const diffHours = Math.floor(diffMinutes / 60);
  if (diffHours < 24) return `${diffHours} hr ago`;
  const diffDays = Math.floor(diffHours / 24);
  return `${diffDays} day ago`;
}

function formatLocalDateTime(iso: string, timeZone: string | null) {
  const date = new Date(iso);
  if (Number.isNaN(date.getTime())) return "unknown";
  const options: Intl.DateTimeFormatOptions = {
    dateStyle: "medium",
    timeStyle: "short",
    ...(timeZone ? { timeZone } : {}),
  };
  return new Intl.DateTimeFormat(undefined, options).format(date);
}

function getUserTimeZone() {
  return Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
}

type ExperienceRequirementSignal = {
  key: string;
  label: string;
  evidence: string;
  minYears: number;
  isRequired: boolean;
};

const EXPERIENCE_SOFT_RE = /\b(preferred|nice to have|nice-to-have|bonus|desired|a plus)\b/i;
const EXPERIENCE_HARD_RE =
  /\b(require|required|requirements|qualification|qualifications|minimum|at least|must have|must-have|must be)\b/i;
const EXPERIENCE_CONTEXT_RE =
  /\b(experience|exp|in (software|engineering|frontend|backend|full stack|development|devops|data|product|role|position|industry|field))\b/i;
const COMPANY_TENURE_RE =
  /\b(for|over|more than|around|about|nearly|almost|since)\b.*\b(company|startup|business|organisation|organization|team|firm|history|founded)\b/i;

function parseExperienceGate(description: string): ExperienceRequirementSignal[] {
  if (!description) return [];
  const normalized = description.replace(/\u2013|\u2014/g, "-").replace(/\s+/g, " ").trim();
  if (!normalized) return [];

  const segments = normalized
    .split(/[\n.;]+/)
    .map((segment) => segment.trim())
    .filter(Boolean);

  const output: ExperienceRequirementSignal[] = [];
  const seen = new Set<string>();

  const emit = (
    label: string,
    minYears: number,
    segment: string,
    isRequired: boolean,
  ) => {
    const key = `${label.toLowerCase()}|${isRequired ? "required" : "preferred"}`;
    if (seen.has(key)) return;
    seen.add(key);
    output.push({
      key,
      label: `${isRequired ? "Required" : "Preferred"}: ${label}`,
      evidence: segment,
      minYears,
      isRequired,
    });
  };

  for (const segment of segments) {
    const lower = segment.toLowerCase();
    if (COMPANY_TENURE_RE.test(lower) && !EXPERIENCE_CONTEXT_RE.test(lower)) continue;

    const soft = EXPERIENCE_SOFT_RE.test(lower);
    const hard = EXPERIENCE_HARD_RE.test(lower);
    const hasExperienceContext = EXPERIENCE_CONTEXT_RE.test(lower);
    if (!hasExperienceContext && !hard && !soft) continue;

    let matched = false;

    const rangeMatch = segment.match(/\b(\d{1,2})\s*(?:-|to)\s*(\d{1,2})\s*(?:years?|yrs?)\b/i);
    if (rangeMatch) {
      const start = Number(rangeMatch[1]);
      const end = Number(rangeMatch[2]);
      if (Number.isFinite(start) && Number.isFinite(end)) {
        const minYears = Math.min(start, end);
        const maxYears = Math.max(start, end);
        emit(`${minYears}-${maxYears} years`, minYears, segment, hard && !soft);
        matched = true;
      }
    }

    const plusMatch = segment.match(/\b(\d{1,2})\s*\+\s*(?:years?|yrs?)\b/i);
    if (plusMatch) {
      const years = Number(plusMatch[1]);
      if (Number.isFinite(years)) {
        emit(`${years}+ years`, years, segment, hard && !soft);
        matched = true;
      }
    }

    if (!matched) {
      const plainMatch = segment.match(
        /\b(\d{1,2})\s*(?:years?|yrs?)\b(?:\s*(?:of|in))?\s*(?:\w+\s+){0,3}(?:experience|exp|role|position|industry|field)\b/i,
      );
      if (plainMatch) {
        const years = Number(plainMatch[1]);
        if (Number.isFinite(years)) {
          emit(`${years}+ years`, years, segment, hard && !soft);
        }
      }
    }
  }

  return output
    .sort((a, b) => {
      if (a.isRequired !== b.isRequired) return a.isRequired ? -1 : 1;
      return b.minYears - a.minYears;
    })
    .slice(0, 4);
}

export function JobsClient({
  initialItems = [],
  initialCursor = null,
}: {
  initialItems?: JobItem[];
  initialCursor?: string | null;
}) {
  const { toast } = useToast();
  const { isTaskHighlighted, markTaskComplete } = useGuide();
  const { runId: fetchRunId, status: fetchStatus, importedCount: fetchImportedCount } = useFetchStatus();
  const guideHighlightClass =
    "ring-2 ring-emerald-400 ring-offset-2 ring-offset-white shadow-[0_0_0_4px_rgba(16,185,129,0.18)]";
  const queryClient = useQueryClient();
  const [error, setError] = useState<string | null>(null);
  const [updatingIds, setUpdatingIds] = useState<Set<string>>(new Set());
  const [deletingIds, setDeletingIds] = useState<Set<string>>(new Set());
  const [previewOpen, setPreviewOpen] = useState(false);
  const [pdfPreview, setPdfPreview] = useState<{
    url: string;
    filename: string;
    label: string;
  } | null>(null);
  const [externalDialogOpen, setExternalDialogOpen] = useState(false);
  const [externalPromptLoading, setExternalPromptLoading] = useState(false);
  const [externalSkillPackLoading, setExternalSkillPackLoading] = useState(false);
  const [externalTarget, setExternalTarget] = useState<"resume" | "cover">("resume");
  const [externalPromptText, setExternalPromptText] = useState("");
  const [externalModelOutput, setExternalModelOutput] = useState("");
  const [externalGenerating, setExternalGenerating] = useState(false);
  const [externalStep, setExternalStep] = useState<1 | 2 | 3>(1);
  const [externalPromptMeta, setExternalPromptMeta] = useState<ExternalPromptMeta | null>(null);
  const [externalSkillPackFresh, setExternalSkillPackFresh] = useState(false);
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [deleteCandidate, setDeleteCandidate] = useState<{ id: string; title: string } | null>(null);
  const [tailorSourceByJob, setTailorSourceByJob] = useState<
    Record<string, { cv?: CvSource; cover?: CoverSource }>
  >({});
  const [cursorStack, setCursorStack] = useState<(string | null)[]>([null]);
  const [pageIndex, setPageIndex] = useState(0);
  const [cursor, setCursor] = useState<string | null>(null);
  const lastSeenImportRef = useRef<{
    runId: string | null;
    status: FetchRunStatus | null;
    importedCount: number;
  } | null>(null);
  const lastImportRefreshAtRef = useRef<number>(0);

  const [statusFilter, setStatusFilter] = useState<JobStatus | "ALL">("ALL");
  const [q, setQ] = useState("");
  const pageSize = 10;
  const [sortOrder, setSortOrder] = useState<"newest" | "oldest">("newest");
  const [locationFilter, setLocationFilter] = useState("ALL");
  const [jobLevelFilter, setJobLevelFilter] = useState("ALL");
  const [selectedId, setSelectedId] = useState<string | null>(initialItems[0]?.id ?? null);
  const [expandedDescriptions, setExpandedDescriptions] = useState<Record<string, boolean>>({});
  const [timeZone] = useState<string | null>(() => getUserTimeZone() || null);
  const [isPending, startTransition] = useTransition();
  const resultsScrollRef = useRef<HTMLDivElement | null>(null);

  function getErrorMessage(err: unknown, fallback = "Failed") {
    if (err instanceof Error) return err.message;
    if (typeof err === "string") return err;
    return fallback;
  }

  function parseTailorOutput(
    raw: string,
    target: "resume" | "cover",
  ): ResumeImportOutput | CoverImportOutput | null {
    const source = raw.trim();
    if (!source) return null;

    const extractFirstJsonObject = (value: string): string | null => {
      let inString = false;
      let escaped = false;
      let depth = 0;
      let start = -1;
      for (let index = 0; index < value.length; index += 1) {
        const char = value[index];
        if (start < 0) {
          if (char === "{") {
            start = index;
            depth = 1;
            inString = false;
            escaped = false;
          }
          continue;
        }
        if (inString) {
          if (escaped) {
            escaped = false;
            continue;
          }
          if (char === "\\") {
            escaped = true;
            continue;
          }
          if (char === '"') {
            inString = false;
          }
          continue;
        }
        if (char === '"') {
          inString = true;
          continue;
        }
        if (char === "{") {
          depth += 1;
          continue;
        }
        if (char === "}") {
          depth -= 1;
          if (depth === 0) {
            return value.slice(start, index + 1);
          }
        }
      }
      return null;
    };

    const parseCandidate = (candidate: string) => {
      try {
        return JSON.parse(candidate) as unknown;
      } catch {
        return null;
      }
    };

    let parsed = parseCandidate(source);
    if (!parsed) {
      const repaired = source
        .replace(/[\u201C\u201D]/g, '"')
        .replace(/[\u2018\u2019]/g, "'")
        .replace(/\u00A0/g, " ")
        .replace(/,\s*([}\]])/g, "$1");
      parsed = parseCandidate(repaired);
      if (!parsed) {
        const fenced = repaired.match(/```(?:json)?\s*([\s\S]*?)\s*```/i)?.[1];
        if (fenced) parsed = parseCandidate(fenced.trim());
      }
      if (!parsed) {
        const firstObject = extractFirstJsonObject(repaired);
        if (firstObject) parsed = parseCandidate(firstObject);
      }
    }
    if (!parsed || typeof parsed !== "object") return null;

    const obj = parsed as Record<string, unknown>;
    if (target === "resume") {
      const cvSummary =
        typeof obj.cvSummary === "string"
          ? obj.cvSummary.trim()
          : typeof obj.summary === "string"
            ? obj.summary.trim()
            : "";
      const latestExperience =
        obj.latestExperience && typeof obj.latestExperience === "object"
          ? (obj.latestExperience as Record<string, unknown>)
          : null;
      const bullets =
        latestExperience && Array.isArray(latestExperience.bullets)
          ? latestExperience.bullets.filter((item): item is string => typeof item === "string").map((item) => item.trim()).filter(Boolean)
          : [];
      if (!cvSummary || bullets.length === 0) return null;
      return { cvSummary };
    }

    const coverRoot =
      obj.cover && typeof obj.cover === "object"
        ? (obj.cover as Record<string, unknown>)
        : obj;
    const paragraphOne =
      typeof coverRoot.paragraphOne === "string"
        ? coverRoot.paragraphOne.trim()
        : typeof coverRoot.p1 === "string"
          ? coverRoot.p1.trim()
          : "";
    const paragraphTwo =
      typeof coverRoot.paragraphTwo === "string"
        ? coverRoot.paragraphTwo.trim()
        : typeof coverRoot.p2 === "string"
          ? coverRoot.p2.trim()
          : "";
    const paragraphThree =
      typeof coverRoot.paragraphThree === "string"
        ? coverRoot.paragraphThree.trim()
        : typeof coverRoot.p3 === "string"
          ? coverRoot.p3.trim()
          : "";

    if (!paragraphOne || !paragraphTwo || !paragraphThree) return null;

    return {
      cover: {
        subject: typeof coverRoot.subject === "string" ? coverRoot.subject.trim() : undefined,
        date: typeof coverRoot.date === "string" ? coverRoot.date.trim() : undefined,
        salutation:
          typeof coverRoot.salutation === "string" ? coverRoot.salutation.trim() : undefined,
        paragraphOne,
        paragraphTwo,
        paragraphThree,
        closing: typeof coverRoot.closing === "string" ? coverRoot.closing.trim() : undefined,
        signatureName:
          typeof coverRoot.signatureName === "string"
            ? coverRoot.signatureName.trim()
            : undefined,
      },
    };
  }

  const debouncedQ = useDebouncedValue(q, 200);

  const debouncedFilters = useMemo(
    () => ({
      q: debouncedQ,
      statusFilter,
      locationFilter,
      jobLevelFilter,
      sortOrder,
      pageSize,
    }),
    [debouncedQ, statusFilter, locationFilter, jobLevelFilter, sortOrder, pageSize],
  );

  useEffect(() => {
    return () => {
      if (pdfPreview?.url) {
        URL.revokeObjectURL(pdfPreview.url);
      }
    };
  }, [pdfPreview?.url]);

  const queryString = useMemo(() => {
    const sp = new URLSearchParams();
    sp.set("limit", String(debouncedFilters.pageSize));
    if (debouncedFilters.statusFilter !== "ALL") sp.set("status", debouncedFilters.statusFilter);
    if (debouncedFilters.q.trim()) sp.set("q", debouncedFilters.q.trim());
    if (debouncedFilters.locationFilter !== "ALL") sp.set("location", debouncedFilters.locationFilter);
    if (debouncedFilters.jobLevelFilter !== "ALL") sp.set("jobLevel", debouncedFilters.jobLevelFilter);
    sp.set("sort", debouncedFilters.sortOrder);
    return sp.toString();
  }, [debouncedFilters]);

  const initialQueryRef = useRef<string | null>(null);
  if (initialQueryRef.current === null) {
    initialQueryRef.current = queryString;
  }
  const didHydrateInitialRef = useRef(false);

  // Force SSR-provided initialItems into the React Query cache for the default "page 1" view,
  // even if a fresh cache entry already exists (e.g. navigating back within staleTime).
  useLayoutEffect(() => {
    if (didHydrateInitialRef.current) return;
    const shouldUseInitial =
      initialItems.length > 0 &&
      cursor === null &&
      pageIndex === 0 &&
      initialQueryRef.current === queryString;
    if (!shouldUseInitial) return;

    const initialLevels = Array.from(
      new Set(
        initialItems
          .map((item) => item.jobLevel)
          .filter((level): level is string => Boolean(level)),
      ),
    );

    const key = ["jobs", queryString, null] as const;
    queryClient.setQueryData<JobsResponse>(key, (old) => ({
      ...old,
      items: initialItems,
      nextCursor: initialCursor ?? null,
      facets: {
        ...(old?.facets ?? {}),
        jobLevels: old?.facets?.jobLevels ?? initialLevels,
      },
      totalCount: old?.totalCount,
    }));
    didHydrateInitialRef.current = true;
  }, [cursor, initialCursor, initialItems, pageIndex, queryClient, queryString]);

  const jobsQuery = useQuery({
    queryKey: ["jobs", queryString, cursor],
    queryFn: async ({ signal }): Promise<JobsResponse> => {
      const sp = new URLSearchParams(queryString);
      if (cursor) sp.set("cursor", cursor);
      const res = await fetch(`/api/jobs?${sp.toString()}`, { signal });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "Failed to load jobs");
      return {
        items: json.items ?? [],
        nextCursor: json.nextCursor ?? null,
        totalCount: typeof json.totalCount === "number" ? json.totalCount : undefined,
        facets: json.facets ?? undefined,
      };
    },
    enabled: Boolean(queryString),
    placeholderData: (prev) => prev,
    refetchOnWindowFocus: false,
    staleTime: 30_000,
    initialData: (): JobsResponse | undefined => {
      const shouldUseInitial =
        initialItems.length > 0 &&
        cursor === null &&
        pageIndex === 0 &&
        initialQueryRef.current === queryString;
      if (!shouldUseInitial) return undefined;
      const initialLevels = Array.from(
        new Set(
          initialItems
            .map((item) => item.jobLevel)
            .filter((level): level is string => Boolean(level)),
        ),
      );
      return {
        items: initialItems,
        nextCursor: initialCursor ?? null,
        facets: {
          jobLevels: initialLevels,
        },
      };
    },
  });

  const items = useMemo(() => jobsQuery.data?.items ?? [], [jobsQuery.data?.items]);
  const totalCount = jobsQuery.data?.totalCount;
  const nextCursor = jobsQuery.data?.nextCursor ?? null;
  const loading = jobsQuery.isFetching;
  const delayedLoading = useDebouncedValue(loading, 160);
  const showLoadingOverlay = (loading ? delayedLoading : false) || isPending;
  const listOpacityClass = showLoadingOverlay ? "opacity-70" : "opacity-100";
  const queryError = jobsQuery.error
    ? getErrorMessage(jobsQuery.error, "Failed to load jobs")
    : null;

  const activeError = error ?? queryError;
  const prevDisabled = loading || pageIndex === 0;
  const nextDisabled = loading || !nextCursor;

  const jobLevelOptions = useMemo(() => {
    const fromItems = items
      .map((item) => item.jobLevel)
      .filter((level): level is string => Boolean(level));
    const fromFacets = jobsQuery.data?.facets?.jobLevels ?? [];
    return Array.from(new Set([...fromFacets, ...fromItems]));
  }, [items, jobsQuery.data?.facets?.jobLevels]);


  function scrollToTop() {
    if (typeof window === "undefined") return;
    window.scrollTo({ top: 0, behavior: "smooth" });
    // Also reset the ScrollArea viewport so the list starts from the top.
    const viewport = resultsScrollRef.current?.querySelector(
      "[data-radix-scroll-area-viewport]",
    );
    if (viewport) viewport.scrollTop = 0;
  }

  function triggerSearch() {
    resetPagination();
    queryClient.invalidateQueries({ queryKey: ["jobs"] });
  }

  const resetPagination = useMemo(
    () => () => {
      setCursorStack([null]);
      setPageIndex(0);
      setCursor(null);
    },
    [],
  );

  // If a Fetch Run imports new jobs, refresh the jobs list to surface the newest data quickly.
  // Terminal state: always reset to page 1 and refresh.
  // In-progress: refresh only when already on page 1 (throttled) to avoid disrupting browsing.
  useEffect(() => {
    const current = {
      runId: fetchRunId ?? null,
      status: (fetchStatus ?? null) as FetchRunStatus | null,
      importedCount: typeof fetchImportedCount === "number" ? fetchImportedCount : 0,
    };
    const previous = lastSeenImportRef.current;
    lastSeenImportRef.current = current;

    if (!current.runId || !current.status) return;
    if (!previous || previous.runId !== current.runId) return;

    const delta = current.importedCount - previous.importedCount;
    if (delta <= 0) return;

    const isTerminal = current.status === "SUCCEEDED" || current.status === "FAILED";
    const wasTerminal = previous.status === "SUCCEEDED" || previous.status === "FAILED";
    const justBecameTerminal = isTerminal && !wasTerminal;
    const isFirstPage = pageIndex === 0 && cursor === null;
    const inProgress = current.status === "RUNNING" || current.status === "QUEUED";

    if (!justBecameTerminal && !(inProgress && isFirstPage)) return;

    if (!justBecameTerminal) {
      const now = Date.now();
      if (now - lastImportRefreshAtRef.current < 5000) return;
      lastImportRefreshAtRef.current = now;
    }

    resetPagination();
    queryClient.invalidateQueries({ queryKey: ["jobs"], refetchType: "active" });

    if (justBecameTerminal) {
      toast({
        title: "Jobs imported",
        description: `Imported ${delta} new job${delta === 1 ? "" : "s"}. Refreshing list.`,
        duration: 2200,
        className:
          "border-emerald-200 bg-emerald-50 text-emerald-900 animate-in fade-in zoom-in-95",
      });
    }
  }, [
    cursor,
    fetchImportedCount,
    fetchRunId,
    fetchStatus,
    pageIndex,
    queryClient,
    resetPagination,
    toast,
  ]);

  function getStatusFilterFromJobsQueryKey(queryKey: readonly unknown[]): JobStatus | "ALL" {
    const serializedQuery = typeof queryKey[1] === "string" ? queryKey[1] : "";
    const statusParam = new URLSearchParams(serializedQuery).get("status");
    if (statusParam === "NEW" || statusParam === "APPLIED" || statusParam === "REJECTED") {
      return statusParam;
    }
    return "ALL";
  }

  const updateStatusMutation = useMutation({
    mutationFn: async ({ id, status }: { id: string; status: JobStatus }) => {
      const res = await fetch(`/api/jobs/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status }),
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "Failed to update status");
      return json as {
        resumeSaved?: boolean;
        resumePdfUrl?: string | null;
        resumePdfName?: string | null;
        saveError?: { code: string; message: string } | null;
      };
    },
    onMutate: async ({ id, status }) => {
      setError(null);
      setUpdatingIds((prev) => new Set(prev).add(id));
      await queryClient.cancelQueries({ queryKey: ["jobs"] });
      const previousEntries = queryClient.getQueriesData<JobsResponse>({ queryKey: ["jobs"] });

      for (const [entryKey] of previousEntries) {
        const key = Array.isArray(entryKey) ? entryKey : [];
        const currentFilter = getStatusFilterFromJobsQueryKey(key);
        const shouldKeep = currentFilter === "ALL" || currentFilter === status;
        queryClient.setQueryData<JobsResponse>(entryKey, (old) => {
          if (!old || !Array.isArray(old.items)) return old;
          const didRemove = !shouldKeep && old.items.some((it) => it.id === id);
          return {
            ...old,
            items: shouldKeep
              ? old.items.map((it) => (it.id === id ? { ...it, status } : it))
              : old.items.filter((it) => it.id !== id),
            totalCount:
              didRemove && typeof old.totalCount === "number"
                ? old.totalCount - 1
                : old.totalCount,
          };
        });
      }

      return { previousEntries };
    },
    onError: (e, _variables, context) => {
      if (context?.previousEntries?.length) {
        for (const [entryKey, entryData] of context.previousEntries) {
          queryClient.setQueryData(entryKey, entryData);
        }
      }
      setError(getErrorMessage(e, "Failed to update status"));
      toast({
        title: "Update failed",
        description: getErrorMessage(e, "The change could not be saved."),
        variant: "destructive",
        duration: 2200,
        className:
          "border-rose-200 bg-rose-50 text-rose-900 animate-in fade-in zoom-in-95",
      });
    },
    onSuccess: (data, variables) => {
      queryClient.invalidateQueries({ queryKey: ["jobs"], refetchType: "active" });
      markTaskComplete("triage_first_job");
      if (data?.resumeSaved || data?.resumePdfUrl) {
        markTaskComplete("generate_first_pdf");
      }
      toast({
        title: "Status updated",
        description: `${variables.status}`,
        duration: 1800,
        className:
          "border-emerald-200 bg-emerald-50 text-emerald-900 animate-in fade-in zoom-in-95",
      });

      if (data?.resumePdfUrl) {
        const cachedEntries = queryClient.getQueriesData<JobsResponse>({ queryKey: ["jobs"] });
        for (const [entryKey] of cachedEntries) {
          queryClient.setQueryData<JobsResponse>(entryKey, (old) => {
            if (!old || !Array.isArray(old.items)) return old;
            return {
              ...old,
              items: old.items.map((it) =>
                it.id === variables.id
                  ? { ...it, resumePdfUrl: data.resumePdfUrl, resumePdfName: data.resumePdfName }
                  : it,
              ),
            };
          });
        }
      }

      if (data?.saveError) {
        toast({
          title: "Saved with warnings",
          description: data.saveError.message,
          duration: 2400,
          className:
            "border-amber-200 bg-amber-50 text-amber-900 animate-in fade-in zoom-in-95",
        });
      } else if (data?.resumeSaved) {
        toast({
          title: "Resume saved",
          description: "Saved to your applied job.",
          duration: 2000,
          className:
            "border-emerald-200 bg-emerald-50 text-emerald-900 animate-in fade-in zoom-in-95",
        });
      }
    },
    onSettled: (_data, _error, variables) => {
      if (!variables) return;
      setUpdatingIds((prev) => {
        const next = new Set(prev);
        next.delete(variables.id);
        return next;
      });
    },
  });

  const deleteMutation = useMutation({
    mutationFn: async (id: string) => {
      const res = await fetch(`/api/jobs/${id}`, { method: "DELETE" });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "Failed to delete job");
    },
    onMutate: async (id) => {
      setError(null);
      setDeletingIds((prev) => new Set(prev).add(id));
      const queryKey = ["jobs", queryString, cursor] as const;
      await queryClient.cancelQueries({ queryKey });
      const previous = queryClient.getQueryData<JobsResponse>(queryKey);
      const previousSelectedId = selectedId;

      let nextSelectedId = selectedId;
      queryClient.setQueryData<JobsResponse>(queryKey, (old) => {
        if (!old) return old;
        const nextItems = old.items.filter((it) => it.id !== id);
        if (selectedId === id) nextSelectedId = nextItems[0]?.id ?? null;
        return {
          ...old,
          items: nextItems,
          totalCount: typeof old.totalCount === "number" ? old.totalCount - 1 : old.totalCount,
        };
      });
      if (selectedId === id) {
        setSelectedId(nextSelectedId);
      }

      return { previous, previousSelectedId, queryKey };
    },
    onError: (e, id, context) => {
      setError(getErrorMessage(e, "Failed to delete job"));
      if (context?.previous) {
        queryClient.setQueryData(context.queryKey, context.previous);
      } else {
        queryClient.invalidateQueries({ queryKey: ["jobs"] });
      }
      if (context?.previousSelectedId) {
        setSelectedId(context.previousSelectedId);
      }
      toast({
        title: "Delete failed",
        description: getErrorMessage(e, "The job could not be removed."),
        variant: "destructive",
        duration: 2400,
        className:
          "border-rose-200 bg-rose-50 text-rose-900 animate-in fade-in zoom-in-95",
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["jobs"], refetchType: "active" });
      toast({
        title: "Job deleted",
        description: "The role was removed.",
        duration: 1800,
        className:
          "border-emerald-200 bg-emerald-50 text-emerald-900 animate-in fade-in zoom-in-95",
      });
    },
    onSettled: (_data, _error, id) => {
      if (!id) return;
      setDeletingIds((prev) => {
        const next = new Set(prev);
        next.delete(id);
        return next;
      });
    },
  });

  async function updateStatus(id: string, status: JobStatus) {
    const previous = items.find((it) => it.id === id)?.status;
    if (!previous || previous === status) return;
    updateStatusMutation.mutate({ id, status });
  }

  function filenameFromDisposition(disposition: string | null) {
    if (!disposition) return null;
    const match = disposition.match(/filename="?([^"]+)"?/i);
    return match?.[1] ?? null;
  }

  function openPdfPreview(blob: Blob, filename: string, label: string) {
    const objectUrl = URL.createObjectURL(blob);
    setPdfPreview({ url: objectUrl, filename, label });
    setPreviewOpen(true);
  }

  async function loadTailorPrompt(job: JobItem, target: "resume" | "cover"): Promise<{
    promptText: string;
    promptMeta: ExternalPromptMeta | null;
  }> {
    const res = await fetch("/api/applications/prompt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ jobId: job.id, target }),
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) {
      throw new Error(json?.error?.message || json?.error || "Failed to build prompt");
    }
    const promptText = [
      "You are given SYSTEM and USER instructions below.",
      "Follow them strictly.",
      "Output MUST be exactly one valid JSON object.",
      "Do not add any markdown, code fences, notes, or extra text before/after JSON.",
      "",
      "=== SYSTEM INSTRUCTIONS START ===",
      json.prompt?.systemPrompt ?? "",
      "=== SYSTEM INSTRUCTIONS END ===",
      "",
      "=== USER INSTRUCTIONS START ===",
      json.prompt?.userPrompt ?? "",
      "=== USER INSTRUCTIONS END ===",
      "",
      "=== JSON OUTPUT CONTRACT ===",
      JSON.stringify(json.expectedJsonShape ?? {}, null, 2),
      "=== END CONTRACT ===",
    ].join("\n");
    const promptMeta: ExternalPromptMeta | null =
      json?.promptMeta &&
      typeof json.promptMeta.ruleSetId === "string" &&
      typeof json.promptMeta.resumeSnapshotUpdatedAt === "string"
        ? {
            ruleSetId: json.promptMeta.ruleSetId,
            resumeSnapshotUpdatedAt: json.promptMeta.resumeSnapshotUpdatedAt,
          }
        : null;
    return { promptText, promptMeta };
  }

  async function openExternalGenerateDialog(job: JobItem, target: "resume" | "cover") {
    setExternalDialogOpen(true);
    setExternalTarget(target);
    setExternalStep(1);
    setExternalModelOutput("");
    setExternalPromptText("");
    setExternalPromptMeta(null);
    setExternalSkillPackFresh(false);
    setError(null);
    setExternalPromptLoading(true);
    try {
      const { promptText, promptMeta } = await loadTailorPrompt(job, target);
      setExternalPromptText(promptText);
      setExternalPromptMeta(promptMeta);
      const fresh = isSkillPackFresh(promptMeta);
      setExternalSkillPackFresh(fresh);
      setExternalStep(fresh ? 2 : 1);
    } catch (e) {
      const message = getErrorMessage(e, "Failed to initialize external AI flow");
      setError(message);
      toast({
        title: "Generate failed",
        description: message,
        variant: "destructive",
        duration: 2600,
        className:
          "border-rose-200 bg-rose-50 text-rose-900 animate-in fade-in zoom-in-95",
      });
    } finally {
      setExternalPromptLoading(false);
    }
  }

  async function copyPromptText() {
    if (!externalPromptText.trim()) return;
    if (navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(externalPromptText);
      setExternalStep(3);
      toast({
        title: "Prompt copied",
        description: "Paste it into ChatGPT/Gemini/Claude and return JSON here.",
        duration: 2200,
        className:
          "border-emerald-200 bg-emerald-50 text-emerald-900 animate-in fade-in zoom-in-95",
      });
      return;
    }
    const blob = new Blob([externalPromptText], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const anchor = document.createElement("a");
    anchor.href = url;
    anchor.download = "jobflow-tailor-prompt.txt";
    anchor.click();
    URL.revokeObjectURL(url);
    toast({
      title: "Prompt ready",
      description: "Clipboard unavailable. Prompt text downloaded as a file.",
      duration: 2200,
      className: "border-slate-200 bg-slate-50 text-slate-900 animate-in fade-in zoom-in-95",
    });
  }

  async function downloadSkillPack() {
    if (externalPromptLoading || !externalPromptMeta) {
      return;
    }
    setExternalSkillPackLoading(true);
    setError(null);
    try {
      const res = await fetch("/api/prompt-rules/skill-pack", { cache: "no-store" });
      if (!res.ok) {
        const json = await res.json().catch(() => ({}));
        throw new Error(json?.error?.message || json?.error || "Failed to download skill pack");
      }
      const blob = await res.blob();
      const fallbackName = "jobflow-skill-pack.tar.gz";
      const filename = filenameFromDisposition(res.headers.get("content-disposition")) || fallbackName;
      const objectUrl = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = objectUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(objectUrl);
      if (externalPromptMeta) {
        writeSavedSkillPackMeta(externalPromptMeta);
        setExternalSkillPackFresh(true);
        setExternalStep(2);
      }
      toast({
        title: "Skill pack downloaded",
        description: "Skill pack marked as up-to-date for current prompt.",
        duration: 2200,
        className:
          "border-emerald-200 bg-emerald-50 text-emerald-900 animate-in fade-in zoom-in-95",
      });
    } catch (e) {
      const message = getErrorMessage(e, "Failed to download skill pack");
      setError(message);
      toast({
        title: "Download failed",
        description: message,
        variant: "destructive",
        duration: 2600,
        className:
          "border-rose-200 bg-rose-50 text-rose-900 animate-in fade-in zoom-in-95",
      });
    } finally {
      setExternalSkillPackLoading(false);
    }
  }

  async function generateFromImportedJson(job: JobItem, target: "resume" | "cover", modelOutput: string) {
    setExternalGenerating(true);
    setError(null);
    try {
      const res = await fetch("/api/applications/manual-generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          jobId: job.id,
          target,
          modelOutput,
          promptMeta: externalPromptMeta,
        }),
      });

      if (!res.ok) {
        const json = await res.json().catch(() => ({}));
        const baseMessage = json?.error?.message || json?.error || "Failed to generate PDF";
        const details = Array.isArray(json?.error?.details)
          ? json.error.details.filter((item: unknown) => typeof item === "string")
          : [];
        const detailText = details.length ? ` (${details.slice(0, 2).join(" | ")})` : "";
        throw new Error(`${baseMessage}${detailText}`);
      }

      const blob = await res.blob();
      const filename =
        filenameFromDisposition(res.headers.get("content-disposition")) ||
        (target === "resume" ? "resume.pdf" : "cover-letter.pdf");
      openPdfPreview(blob, filename, target === "resume" ? "Resume preview" : "Cover letter preview");
      markTaskComplete("generate_first_pdf");

      if (target === "resume") {
        setTailorSourceByJob((prev) => ({
          ...prev,
          [job.id]: { ...prev[job.id], cv: "manual_import" },
        }));
      } else {
        setTailorSourceByJob((prev) => ({
          ...prev,
          [job.id]: { ...prev[job.id], cover: "manual_import" },
        }));
      }

      setExternalDialogOpen(false);
      toast({
        title: "PDF generated",
        description:
          target === "resume"
            ? "CV generated from imported AI JSON."
            : "Cover letter generated from imported AI JSON.",
        duration: 2200,
        className:
          "border-emerald-200 bg-emerald-50 text-emerald-900 animate-in fade-in zoom-in-95",
      });
    } catch (e) {
      const message = getErrorMessage(e, "Failed to generate PDF");
      setError(message);
      toast({
        title: "Import failed",
        description: message,
        variant: "destructive",
        duration: 2600,
        className:
          "border-rose-200 bg-rose-50 text-rose-900 animate-in fade-in zoom-in-95",
      });
    } finally {
      setExternalGenerating(false);
    }
  }

  function scheduleDelete(job: JobItem) {
    if (deletingIds.has(job.id)) return;
    setDeleteCandidate({ id: job.id, title: job.title });
    setDeleteConfirmOpen(true);
  }

  function confirmDeleteCandidate() {
    if (!deleteCandidate) return;
    deleteMutation.mutate(deleteCandidate.id);
    setDeleteConfirmOpen(false);
    setDeleteCandidate(null);
  }

  const statusClass: Record<JobStatus, string> = {
    NEW: "bg-emerald-100 text-emerald-700",
    APPLIED: "bg-sky-100 text-sky-700",
    REJECTED: "bg-slate-200 text-slate-600",
  };
  const statusLabel: Record<JobStatus, string> = {
    NEW: "New",
    APPLIED: "Applied",
    REJECTED: "Rejected",
  };

  const effectiveSelectedId = useMemo(() => {
    if (!items.length) return null;
    if (selectedId && items.some((it) => it.id === selectedId)) return selectedId;
    return items[0]?.id ?? null;
  }, [items, selectedId]);

  const selectedJob = items.find((it) => it.id === effectiveSelectedId) ?? null;
  const selectedTailorSource = selectedJob ? tailorSourceByJob[selectedJob.id] : undefined;
  const isAppliedSelected = selectedJob?.status === "APPLIED";
  const highlightTriage = isTaskHighlighted("triage_first_job");
  const highlightGenerate = isTaskHighlighted("generate_first_pdf");
  const highlightDownload = isTaskHighlighted("download_first_pdf");
  const parsedExternalOutput = useMemo(
    () => parseTailorOutput(externalModelOutput, externalTarget),
    [externalModelOutput, externalTarget],
  );
  const canOpenStep2 = externalSkillPackFresh;
  const canOpenStep3 = externalPromptText.trim().length > 0;
  const externalSteps = useMemo(
    () =>
      [
        { id: 1 as const, label: "Skill Pack", disabled: false },
        { id: 2 as const, label: "Copy Prompt", disabled: !canOpenStep2 },
        { id: 3 as const, label: "Paste JSON", disabled: !canOpenStep3 },
      ] satisfies Array<{ id: 1 | 2 | 3; label: string; disabled: boolean }>,
    [canOpenStep2, canOpenStep3],
  );
  const externalBtnSecondary =
    "h-10 rounded-xl border border-slate-200 bg-white px-4 text-sm font-medium text-slate-700 shadow-sm transition-all duration-200 hover:border-slate-300 hover:bg-slate-50 active:translate-y-[1px] disabled:cursor-not-allowed disabled:border-slate-200 disabled:bg-slate-100 disabled:text-slate-400 disabled:shadow-none";
  const externalBtnPrimary =
    "h-10 rounded-xl border border-emerald-500 bg-emerald-500 px-5 text-sm font-semibold text-white shadow-sm transition-all duration-200 hover:bg-emerald-600 hover:border-emerald-600 active:translate-y-[1px] disabled:cursor-not-allowed disabled:border-slate-300 disabled:bg-slate-200 disabled:text-slate-500 disabled:shadow-none";
  const detailsScrollRef = useRef<HTMLDivElement | null>(null);
  const detailQuery = useQuery({
    queryKey: ["job-details", effectiveSelectedId],
    queryFn: async () => {
      const res = await fetch(`/api/jobs/${effectiveSelectedId}`);
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "Failed to load details");
      return json as { id: string; description: string | null };
    },
    enabled: Boolean(effectiveSelectedId),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
  });
  const fitQuery = useQuery({
    queryKey: ["job-fit", effectiveSelectedId],
    queryFn: async () => {
      const res = await fetch(`/api/jobs/${effectiveSelectedId}/fit-analysis`);
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || json?.message || "Failed to load fit analysis");
      return json as JobFitApiResponse;
    },
    enabled: Boolean(effectiveSelectedId),
    staleTime: 60 * 1000,
    refetchOnWindowFocus: false,
    refetchInterval: (query) => (query.state.data?.status === "PENDING" ? 4000 : false),
  });
  const fitStartMutation = useMutation({
    mutationFn: async (jobId: string) => {
      const res = await fetch(`/api/jobs/${jobId}/fit-analysis`, {
        method: "POST",
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || json?.message || "Failed to start fit analysis");
      return json as JobFitApiResponse;
    },
    onSuccess: (payload, jobId) => {
      queryClient.setQueryData(["job-fit", jobId], payload);
      if (payload.status === "PENDING") {
        queryClient.invalidateQueries({ queryKey: ["job-fit", jobId] });
      }
    },
  });
  const fitTriggerRef = useRef<string | null>(null);
  useEffect(() => {
    if (!effectiveSelectedId) return;
    if (fitTriggerRef.current === effectiveSelectedId) return;
    fitTriggerRef.current = effectiveSelectedId;
    fitStartMutation.mutate(effectiveSelectedId);
  }, [effectiveSelectedId, fitStartMutation]);
  const selectedDescription = selectedJob ? detailQuery.data?.description ?? "" : "";
  const detailError = detailQuery.error
    ? getErrorMessage(detailQuery.error, "Failed to load details")
    : null;
  const detailLoading = detailQuery.isFetching && !detailQuery.data;
  const fitData = selectedJob ? fitQuery.data : undefined;
  const fitReady = fitData?.status === "READY" ? fitData.analysis : null;
  const fitPending = fitData?.status === "PENDING";
  const fitLoading = Boolean(selectedJob) && ((fitStartMutation.isPending && !fitData) || fitQuery.isLoading);
  const fitError = fitData?.status === "FAILED"
    ? fitData.message || "Fit analysis failed."
    : fitQuery.error
      ? getErrorMessage(fitQuery.error, "Fit analysis failed.")
      : null;
  const isLongDescription = selectedDescription.length > 600;
  const experienceSignals = useMemo(
    () => parseExperienceGate(selectedDescription),
    [selectedDescription],
  );
  const isExpanded =
    selectedJob && expandedDescriptions[selectedJob.id] ? true : false;
  const highlightRegex = useMemo(() => {
    const patterns = HIGHLIGHT_KEYWORDS.map((keyword) => {
      const escaped = escapeRegExp(keyword);
      const isPlainWord = /^[a-z0-9.+#-]+$/i.test(keyword);
      return isPlainWord ? `\\b${escaped}\\b` : escaped;
    });
    return new RegExp(`(${patterns.join("|")})`, "i");
  }, []);

  const markdownStyles = useMemo(
    () => ({
      heading: "text-base font-semibold text-slate-900",
      subheading: "text-sm font-semibold text-slate-900",
      paragraph: "text-sm leading-7 text-slate-700",
      list: "list-disc space-y-1 pl-5 text-sm text-slate-700",
      listOrdered: "list-decimal space-y-1 pl-5 text-sm text-slate-700",
      listItem: "text-sm leading-7 text-slate-700",
      blockquote: "border-l-2 border-slate-200 bg-slate-50/60 px-4 py-2 text-sm text-slate-700",
      codeInline: "rounded bg-slate-100 px-1.5 py-0.5 text-xs text-slate-800",
      pre: "rounded-lg border border-slate-200 bg-slate-50 p-3 text-xs text-slate-800 overflow-auto",
      link: "text-emerald-700 underline-offset-4 hover:underline",
      table: "w-full border-collapse text-sm",
      th: "border border-slate-200 bg-slate-50 px-3 py-2 text-left font-semibold text-slate-900",
      td: "border border-slate-200 px-3 py-2 text-slate-700",
    }),
    [],
  );

  function highlightText(text: string) {
    const parts = text.split(highlightRegex);
    return parts.map((part, index) => {
      if (highlightRegex.test(part)) {
        return (
          <mark
            key={`${part}-${index}`}
            className="rounded-sm bg-amber-100/90 px-1 py-0.5 font-medium text-amber-900"
          >
            {part}
          </mark>
        );
      }
      return <span key={`${part}-${index}`}>{part}</span>;
    });
  }

  function renderHighlighted(children: React.ReactNode): React.ReactNode {
    if (typeof children === "string") return highlightText(children);
    if (Array.isArray(children)) {
      return children.map((child, index) => (
        <span key={index}>{renderHighlighted(child)}</span>
      ));
    }
    return children;
  }



  return (
    <>
      <Dialog open={externalDialogOpen} onOpenChange={setExternalDialogOpen}>
        <DialogContent className="flex h-[min(88vh,760px)] w-[min(96vw,860px)] max-w-[860px] flex-col overflow-hidden">
          <DialogHeader>
            <DialogTitle>
              {externalTarget === "resume" ? "Generate CV with External AI" : "Generate Cover Letter with External AI"}
            </DialogTitle>
            <DialogDescription>
              Complete three steps, then generate your PDF.
            </DialogDescription>
          </DialogHeader>

          <div className="flex min-h-0 flex-1 flex-col gap-4">
            <div className="rounded-xl border border-slate-200 bg-white px-3 py-2">
              <div className="relative flex items-center justify-between gap-2">
                <div className="pointer-events-none absolute left-8 right-8 top-4 h-px bg-slate-200" />
                {externalSteps.map((step) => {
                  const isActive = externalStep === step.id;
                  const isDone = externalStep > step.id;
                  return (
                    <button
                      key={step.id}
                      type="button"
                      onClick={() => !step.disabled && setExternalStep(step.id)}
                      disabled={step.disabled}
                      className={[
                        "relative z-10 flex min-w-0 flex-1 items-center justify-center gap-2 rounded-lg px-2 py-1.5 text-xs font-medium transition-all duration-200 sm:text-sm",
                        step.disabled ? "cursor-not-allowed text-slate-400" : "text-slate-700 hover:bg-slate-50",
                        isActive ? "bg-emerald-50 text-emerald-800" : "",
                      ].join(" ")}
                    >
                      <span
                        className={[
                          "inline-flex h-5 w-5 items-center justify-center rounded-full border text-[11px] font-semibold",
                          isDone
                            ? "border-emerald-500 bg-emerald-500 text-white"
                            : isActive
                              ? "border-emerald-400 bg-emerald-100 text-emerald-800"
                              : "border-slate-300 bg-white text-slate-500",
                        ].join(" ")}
                      >
                        {step.id}
                      </span>
                      <span className="truncate">{step.label}</span>
                    </button>
                  );
                })}
              </div>
            </div>

            <div className="min-h-0 flex-1 overflow-y-auto rounded-xl border border-slate-900/10 bg-slate-50/40 p-4">
              {externalStep === 1 ? (
                <div className="space-y-3">
                  <p className="text-sm text-slate-700">
                    {externalSkillPackFresh
                      ? "Your skill pack is up to date. You can skip to Step 2."
                      : "Download the latest skill pack before generating content."}
                  </p>
                  {!externalSkillPackFresh ? (
                    <div className="rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-900">
                      Required: latest rules and resume snapshot.
                    </div>
                  ) : null}
                  <div className="flex flex-wrap gap-2">
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      disabled={
                        !selectedJob ||
                        externalSkillPackLoading ||
                        externalPromptLoading ||
                        !externalPromptMeta
                      }
                      onClick={() => selectedJob && downloadSkillPack()}
                      className={externalBtnSecondary}
                    >
                      {externalSkillPackLoading
                        ? "Downloading..."
                        : externalPromptLoading
                          ? "Preparing..."
                        : externalSkillPackFresh
                          ? "Re-download Skill Pack"
                          : "Download Skill Pack"}
                    </Button>
                    {externalSkillPackFresh ? (
                      <Button type="button" size="sm" onClick={() => setExternalStep(2)} className={externalBtnPrimary}>
                        Continue
                      </Button>
                    ) : null}
                  </div>
                </div>
              ) : null}

              {externalStep === 2 ? (
                <div className="space-y-3">
                  <p className="text-sm text-slate-700">
                    Copy prompt and paste it in ChatGPT/Gemini/Claude with your imported skill pack.
                  </p>
                  <div className="rounded-md border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600">
                    Prompt length: {externalPromptText.length} chars
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      disabled={externalPromptLoading || !externalPromptText.trim()}
                      onClick={copyPromptText}
                      className={externalBtnSecondary}
                    >
                      <Copy className="h-4 w-4" />
                      {externalPromptLoading ? "Building..." : "Copy Prompt"}
                    </Button>
                    <Button type="button" size="sm" onClick={() => setExternalStep(3)} className={externalBtnPrimary}>
                      Continue
                    </Button>
                  </div>
                </div>
              ) : null}

              {externalStep === 3 ? (
                <div className="space-y-3">
                  <div className="text-sm font-medium text-slate-900">Paste AI JSON result</div>
                  <Textarea
                    value={externalModelOutput}
                    onChange={(e) => setExternalModelOutput(e.target.value)}
                    placeholder={
                      externalTarget === "resume"
                        ? '{"cvSummary":"...","latestExperience":{"bullets":["..."]},"skillsFinal":[{"label":"...","items":["..."]}]}'
                        : '{"cover":{"candidateTitle":"...","subject":"Application for <Role>","date":"...","salutation":"Hiring Team at <Company>","paragraphOne":"...","paragraphTwo":"...","paragraphThree":"...","closing":"...","signatureName":"..."}}'
                    }
                    className="min-h-[220px] font-mono text-xs"
                  />
                  {!externalModelOutput.trim() ? null : parsedExternalOutput ? (
                    <div className="rounded-lg border border-emerald-200 bg-emerald-50/60 p-3 text-xs text-emerald-900">
                      JSON parsed successfully.
                    </div>
                  ) : (
                    <div className="rounded-lg border border-rose-200 bg-rose-50/60 p-3 text-xs text-rose-900">
                      JSON parse failed. Keep strict JSON with required keys.
                    </div>
                  )}

                </div>
              ) : null}
            </div>
          </div>

          <div className="flex justify-end gap-2">
            {externalStep > 1 ? (
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => setExternalStep((prev) => (prev === 3 ? 2 : 1))}
                disabled={externalGenerating}
                className={externalBtnSecondary}
              >
                Back
              </Button>
            ) : null}
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => setExternalDialogOpen(false)}
              disabled={externalGenerating}
              className={externalBtnSecondary}
            >
              Cancel
            </Button>
            <Button
              size="sm"
              className={externalBtnPrimary}
              disabled={
                !selectedJob ||
                externalGenerating ||
                externalStep !== 3 ||
                !parsedExternalOutput ||
                externalModelOutput.trim().length < 20
              }
              data-guide-anchor={externalTarget === "resume" ? "generate_first_pdf" : undefined}
              onClick={() =>
                selectedJob &&
                generateFromImportedJson(selectedJob, externalTarget, externalModelOutput)
              }
            >
              {externalGenerating
                ? "Generating..."
                : externalTarget === "resume"
                  ? "Generate CV PDF"
                  : "Generate Cover PDF"}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      <Dialog open={previewOpen} onOpenChange={setPreviewOpen}>
        <DialogContent
          className="h-[92vh] w-[98vw] max-w-[min(98vw,1280px)] overflow-hidden p-0"
          showCloseButton={false}
        >
          <DialogHeader className="sr-only">
            <DialogTitle>{pdfPreview?.label ?? "PDF preview"}</DialogTitle>
            <DialogDescription>Preview the generated PDF.</DialogDescription>
          </DialogHeader>
          <div className="flex h-full flex-col">
            <div className="flex h-11 items-center justify-between border-b border-slate-900/10 bg-white/90 px-3">
              <div className="text-xs font-medium text-slate-600">
                {pdfPreview?.label ?? "PDF preview"}
              </div>
              <div className="flex items-center gap-2">
                {pdfPreview ? (
                  <Button
                    asChild
                    size="sm"
                    variant="outline"
                    className={`h-9 rounded-xl border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 shadow-sm transition-all duration-200 hover:border-slate-300 hover:bg-slate-50 active:translate-y-[1px] ${
                      highlightDownload ? guideHighlightClass : ""
                    }`}
                    data-guide-anchor="download_first_pdf"
                  >
                    <a
                      href={pdfPreview.url}
                      download={pdfPreview.filename}
                      onClick={() => markTaskComplete("download_first_pdf")}
                    >
                      <Download className="mr-1.5 h-4 w-4" />
                      Download PDF
                    </a>
                  </Button>
                ) : null}
                <DialogClose asChild>
                  <Button
                    type="button"
                    size="sm"
                    variant="outline"
                    className="h-9 rounded-xl border-slate-200 bg-white px-3 text-sm font-medium text-slate-700 shadow-sm transition-all duration-200 hover:border-slate-300 hover:bg-slate-50 active:translate-y-[1px]"
                  >
                    Close
                  </Button>
                </DialogClose>
              </div>
            </div>
            <div className="flex-1 bg-white">
              {pdfPreview ? (
                <iframe
                  title={pdfPreview.label}
                  src={pdfPreview.url}
                  className="h-full w-full"
                />
              ) : (
                <div className="flex h-full items-center justify-center text-sm text-muted-foreground">
                  No preview available.
                </div>
              )}
            </div>
          </div>
        </DialogContent>
      </Dialog>

      <div
        data-testid="jobs-shell"
        className="edu-page-enter relative flex h-full flex-1 min-h-0 flex-col gap-6 text-foreground"
      >
      <div className="flex h-full min-h-0 flex-1 flex-col gap-6">
        <div
        data-testid="jobs-toolbar"
        className="rounded-3xl border-2 border-slate-900/10 bg-white/80 p-5 shadow-[0_20px_45px_-35px_rgba(15,23,42,0.35)] backdrop-blur transition-shadow duration-200 ease-out hover:shadow-[0_26px_55px_-40px_rgba(15,23,42,0.4)]"
      >
        <div className="grid gap-4 lg:grid-cols-[1.6fr_1fr_0.8fr_0.8fr_0.9fr_auto] lg:items-end">
          <div className="space-y-2">
            <div className="text-xs text-muted-foreground">Title or Keywords</div>
            <div className="relative">
              <Search className="pointer-events-none absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                className="pl-9"
                placeholder="e.g. software engineer"
                value={q}
                onChange={(e) => {
                  resetPagination();
                  setQ(e.target.value);
                }}
              />
            </div>
          </div>
          <div className="space-y-2">
            <div className="text-xs text-muted-foreground">Location</div>
            <div className="relative">
              <MapPin className="pointer-events-none absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
              <Select
                value={locationFilter}
                onValueChange={(v) => {
                  startTransition(() => {
                    resetPagination();
                    setLocationFilter(v);
                  });
                }}
              >
                <SelectTrigger className="pl-9">
                  <SelectValue placeholder="All locations" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="ALL">All locations</SelectItem>
                  {LOCATION_OPTIONS.map((loc) => (
                    <SelectItem key={loc.value} value={loc.value}>
                      {loc.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>
          <div className="space-y-2">
            <div className="text-xs text-muted-foreground">Job level</div>
            <Select
              value={jobLevelFilter}
              onValueChange={(v) => {
                startTransition(() => {
                  resetPagination();
                  setJobLevelFilter(v);
                });
              }}
            >
              <SelectTrigger>
                <SelectValue placeholder="All levels" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="ALL">All levels</SelectItem>
                {jobLevelOptions.map((level) => (
                  <SelectItem key={level} value={level}>
                    {level}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className="space-y-2">
            <div className="text-xs text-muted-foreground">Status</div>
            <Select
              value={statusFilter}
              onValueChange={(v) => {
                startTransition(() => {
                  resetPagination();
                  setStatusFilter(v as JobStatus | "ALL");
                });
              }}
            >
              <SelectTrigger>
                <SelectValue placeholder="All" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="ALL">All</SelectItem>
                <SelectItem value="NEW">New</SelectItem>
                <SelectItem value="APPLIED">Applied</SelectItem>
                <SelectItem value="REJECTED">Rejected</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <div className="space-y-2" data-testid="jobs-sort">
            <div className="text-xs text-muted-foreground">Posted</div>
            <Select
              value={sortOrder}
              onValueChange={(v) => {
                startTransition(() => {
                  resetPagination();
                  setSortOrder(v as "newest" | "oldest");
                });
              }}
            >
              <SelectTrigger className="h-9 bg-muted/40">
                <SelectValue placeholder="Posted" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="newest">Posted: newest</SelectItem>
                <SelectItem value="oldest">Posted: oldest</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <div className="flex items-end">
            <Button
              onClick={triggerSearch}
              disabled={loading}
              className="h-10 w-full rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 px-6 text-sm font-semibold text-white shadow-md transition-all duration-200 hover:from-emerald-600 hover:to-emerald-700 hover:shadow-lg hover:brightness-105 active:scale-[0.97] disabled:opacity-50 lg:w-auto"
            >
              <Search className="mr-1.5 h-4 w-4" />
              Search
            </Button>
          </div>
        </div>
      </div>

      {activeError ? (
        <div className="rounded-lg border border-destructive/40 bg-destructive/10 p-3 text-sm text-destructive">
          {activeError}
        </div>
      ) : null}

        <section className="relative grid flex-1 min-h-0 gap-4 lg:max-h-[calc(100vh-260px)] lg:grid-cols-[380px_1fr] lg:items-stretch">
        {showLoadingOverlay ? <div className="edu-loading-bar" aria-hidden /> : null}
        <div className="relative flex min-h-[320px] flex-1 flex-col overflow-hidden rounded-3xl border-2 border-slate-900/10 bg-white/80 shadow-[0_18px_40px_-32px_rgba(15,23,42,0.3)] backdrop-blur transition-shadow duration-200 ease-out hover:shadow-[0_24px_50px_-36px_rgba(15,23,42,0.38)] lg:min-h-0 lg:max-h-[calc(100vh-260px)]">
          <div className="flex items-center justify-between border-b px-4 py-3 text-sm font-semibold">
            <span>
              Results
              {typeof totalCount === "number" ? (
                <span className="ml-1.5 text-xs font-normal text-muted-foreground">
                   {totalCount} {totalCount === 1 ? "job" : "jobs"}
                </span>
              ) : null}
            </span>
            <span className="text-xs text-muted-foreground">Page {pageIndex + 1}</span>
          </div>
          <ScrollArea
            ref={resultsScrollRef}
            data-testid="jobs-results-scroll"
            data-loading={showLoadingOverlay ? "true" : "false"}
            data-virtual="false"
            className={`max-h-full flex-1 min-h-0 transition-opacity duration-200 ease-out ${listOpacityClass}`}
          >
            {loading && items.length === 0 ? (
              <div className="space-y-3 p-3">
                {Array.from({ length: 6 }).map((_, idx) => (
                  <div key={`s-${idx}`} className="rounded-lg border p-3">
                    <Skeleton className="h-4 w-2/3" />
                    <Skeleton className="mt-2 h-3 w-1/2" />
                    <Skeleton className="mt-2 h-3 w-1/3" />
                  </div>
                ))}
              </div>
            ) : null}
            {items.length > 0 ? (
              <div className="space-y-3 p-3">
                {items.map((it) => {
                  const active = it.id === effectiveSelectedId;
                  return (
                    <button
                      key={it.id}
                      type="button"
                      onClick={() => {
                        setSelectedId(it.id);
                      }}
                      data-perf="cv-auto"
                      className={`jobflow-list-item w-full rounded-2xl border border-l-4 border-slate-900/10 bg-white/80 px-3 py-3 text-left transition-all duration-200 ease-out hover:-translate-y-[1px] ${
                        active
                          ? "border-l-emerald-500 bg-emerald-50/60 shadow-sm"
                          : "border-l-transparent hover:border-slate-900/20 hover:bg-white"
                      }`}
                    >
                      <div className="flex items-center justify-between gap-2">
                        <Badge className={statusClass[it.status]}>{it.status}</Badge>
                        <span
                          className="text-xs text-muted-foreground"
                          title={formatLocalDateTime(it.createdAt, timeZone)}
                        >
                          {formatInsertedTime(it.createdAt)}
                        </span>
                      </div>
                      <div className="mt-2 text-sm font-semibold">{it.title}</div>
                      <div className="mt-1 text-xs text-muted-foreground">
                        {it.company ?? "-"} - {it.location ?? "-"}
                      </div>
                      <div className="mt-2 text-[11px] text-muted-foreground">
                        {it.jobType ?? "Unknown"} - {it.jobLevel ?? "Unknown"}
                      </div>
                    </button>
                  );
                })}
              </div>
            ) : !loading ? (
              <div className="rounded-lg border border-dashed p-6 text-center text-sm text-muted-foreground">
                No jobs yet.
              </div>
            ) : null}
          </ScrollArea>
          <div className="border-t px-4 py-3">
            <Pagination>
              <PaginationContent>
                <PaginationItem>
                  <PaginationPrevious
                    onClick={() => {
                      if (pageIndex > 0) {
                        scrollToTop();
                        const prevCursor = cursorStack[pageIndex - 1] ?? null;
                        setPageIndex(pageIndex - 1);
                        setCursor(prevCursor);
                      }
                    }}
                    aria-disabled={prevDisabled}
                    className={
                      prevDisabled
                        ? "pointer-events-none cursor-not-allowed opacity-50"
                        : "cursor-pointer"
                    }
                  />
                </PaginationItem>
                <PaginationItem>
                  <PaginationNext
                    onClick={() => {
                      if (loading || !nextCursor) return;
                      scrollToTop();
                      setCursorStack((prev) => {
                        const copy = [...prev];
                        copy[pageIndex + 1] = nextCursor;
                        return copy;
                      });
                      setPageIndex(pageIndex + 1);
                      setCursor(nextCursor);
                    }}
                    aria-disabled={nextDisabled}
                    className={
                      nextDisabled
                        ? "pointer-events-none cursor-not-allowed opacity-50"
                        : "cursor-pointer"
                    }
                  />
                </PaginationItem>
              </PaginationContent>
            </Pagination>
          </div>
        </div>

        <div className="relative flex min-h-[320px] flex-1 flex-col overflow-hidden rounded-3xl border-2 border-slate-900/10 bg-white/80 shadow-[0_18px_40px_-32px_rgba(15,23,42,0.3)] backdrop-blur transition-shadow duration-200 ease-out hover:shadow-[0_24px_50px_-36px_rgba(15,23,42,0.38)] lg:min-h-0 lg:max-h-[calc(100vh-260px)] lg:sticky lg:top-24">
          <div className="border-b px-4 py-3">
            {selectedJob ? (
              <div className="relative flex flex-wrap items-start justify-between gap-3">
                <div className="space-y-1">
                  <div className="flex flex-wrap items-center gap-2">
                    <h2 className="text-lg font-semibold">{selectedJob.title}</h2>
                    <Badge className={statusClass[selectedJob.status]}>{selectedJob.status}</Badge>
                  </div>
                  <div className="text-sm text-muted-foreground">
                    {selectedJob.company ?? "-"}  {selectedJob.location ?? "-"}
                  </div>
                  <div className="text-xs text-muted-foreground">
                    {selectedJob.jobType ?? "Unknown"}  {selectedJob.jobLevel ?? "Unknown"}
                  </div>
                </div>
                <div className="w-full lg:w-auto">
                  <div
                    data-testid="job-primary-actions"
                    className="grid grid-cols-1 gap-2 sm:grid-cols-2 lg:flex lg:flex-wrap lg:items-center"
                  >
                    <Select
                      value={selectedJob.status}
                      onValueChange={(v) => updateStatus(selectedJob.id, v as JobStatus)}
                      disabled={updatingIds.has(selectedJob.id)}
                    >
                      <SelectTrigger
                        className={`rounded-xl border-slate-200 bg-white shadow-sm ${
                          isAppliedSelected ? "h-9 w-full px-3 text-sm sm:w-[118px]" : "h-10 w-full sm:w-[132px]"
                        } ${highlightTriage ? guideHighlightClass : ""}`}
                        data-guide-highlight={highlightTriage ? "true" : "false"}
                        data-guide-anchor="triage_first_job"
                      >
                        <span className="truncate">{statusLabel[selectedJob.status]}</span>
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="NEW">New</SelectItem>
                        <SelectItem value="APPLIED">Applied</SelectItem>
                        <SelectItem value="REJECTED">Rejected</SelectItem>
                      </SelectContent>
                    </Select>
                    <Button
                      asChild
                      size="sm"
                      className={`w-full justify-center rounded-xl border border-emerald-500 bg-emerald-500 text-sm font-semibold text-white shadow-sm transition-all duration-200 hover:border-emerald-600 hover:bg-emerald-600 active:translate-y-[1px] sm:w-auto ${
                        isAppliedSelected ? "h-9 px-3.5" : "h-10 px-4"
                      }`}
                    >
                      <a href={selectedJob.jobUrl} target="_blank" rel="noreferrer">
                        <ExternalLink className="mr-1 h-4 w-4" />
                        Open job
                      </a>
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      disabled={externalPromptLoading}
                      onClick={() => openExternalGenerateDialog(selectedJob, "resume")}
                      className={`w-full justify-center rounded-xl border-slate-200 bg-white text-sm font-medium text-slate-700 shadow-sm transition-all duration-200 hover:border-slate-300 hover:bg-slate-50 active:translate-y-[1px] disabled:cursor-not-allowed disabled:border-slate-200 disabled:bg-slate-100 disabled:text-slate-400 disabled:shadow-none sm:w-auto ${
                        isAppliedSelected ? "h-9 px-3.5" : "h-10 px-4"
                      } ${highlightGenerate ? guideHighlightClass : ""}`}
                      data-guide-highlight={highlightGenerate ? "true" : "false"}
                      data-guide-anchor="generate_first_pdf"
                    >
                      <FileText className="mr-1 h-4 w-4" />
                      Generate CV
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      disabled={externalPromptLoading}
                      onClick={() => openExternalGenerateDialog(selectedJob, "cover")}
                      className={`w-full justify-center rounded-xl border-slate-200 bg-white text-sm font-medium text-slate-700 shadow-sm transition-all duration-200 hover:border-slate-300 hover:bg-slate-50 active:translate-y-[1px] disabled:cursor-not-allowed disabled:border-slate-200 disabled:bg-slate-100 disabled:text-slate-400 disabled:shadow-none sm:w-auto ${
                        isAppliedSelected ? "h-9 px-3.5" : "h-10 px-4"
                      } ${highlightGenerate ? guideHighlightClass : ""}`}
                      data-guide-highlight={highlightGenerate ? "true" : "false"}
                    >
                      <FileText className="mr-1 h-4 w-4" />
                      Generate CL
                    </Button>
                    {selectedJob.resumePdfUrl ? (
                      <Button
                        variant="outline"
                        size="sm"
                        asChild
                        className={`w-full justify-center rounded-xl border-slate-200 bg-white text-sm font-medium text-slate-700 shadow-sm transition-all duration-200 hover:border-slate-300 hover:bg-slate-50 active:translate-y-[1px] sm:w-auto ${
                          isAppliedSelected ? "h-9 px-3.5" : "h-10 px-4"
                        } ${highlightDownload ? guideHighlightClass : ""}`}
                        data-guide-anchor="download_first_pdf"
                      >
                        <a
                          href={selectedJob.resumePdfUrl}
                          target="_blank"
                          rel="noreferrer"
                          onClick={() => markTaskComplete("download_first_pdf")}
                        >
                          Saved CV
                        </a>
                      </Button>
                    ) : null}
                    <Button
                      data-testid="job-remove-button"
                      variant="outline"
                      size="sm"
                      disabled={deletingIds.has(selectedJob.id)}
                      onClick={() => scheduleDelete(selectedJob)}
                      className={`w-full justify-center rounded-xl border-rose-200 bg-rose-50 text-sm font-medium text-rose-700 shadow-sm transition-all duration-200 hover:border-rose-300 hover:bg-rose-100 hover:text-rose-800 active:translate-y-[1px] disabled:cursor-not-allowed disabled:border-slate-200 disabled:bg-slate-100 disabled:text-slate-400 disabled:shadow-none sm:ml-auto sm:w-auto ${
                        isAppliedSelected ? "h-9 px-3.5" : "h-10 px-4"
                      }`}
                    >
                      <Trash2 className="mr-1 h-4 w-4" />
                      Remove
                    </Button>
                  </div>
                </div>
                <div className="w-full rounded-2xl border border-slate-900/10 bg-slate-50/60 p-3" data-testid="job-fit-snapshot">
                  <div className="flex flex-wrap items-center justify-between gap-2">
                    <div className="text-[11px] font-semibold uppercase tracking-wide text-slate-700">
                      AI Fit Snapshot
                    </div>
                    {fitData?.status === "READY" ? (
                      <Badge
                        className={
                          fitData.aiEnhanced
                            ? "bg-cyan-100 text-cyan-800"
                            : "bg-slate-200 text-slate-700"
                        }
                      >
                        {fitData.aiEnhanced ? "AI Enhanced" : "Rule-based"}
                      </Badge>
                    ) : null}
                    {fitReady ? (
                      <Badge className={fitGateClass(fitReady.gateStatus)}>{fitReady.gateStatus}</Badge>
                    ) : null}
                  </div>
                  {fitLoading || fitPending ? (
                    <div className="mt-2 text-sm text-muted-foreground">Analyzing resume vs JD...</div>
                  ) : null}
                  {fitError ? (
                    <div className="mt-2 text-sm text-rose-700">{fitError}</div>
                  ) : null}
                  {fitReady ? (
                    <div className="mt-3 space-y-2">
                      <div className="grid gap-2 sm:grid-cols-4">
                        <div className="rounded-lg border border-slate-200 bg-white px-3 py-2">
                          <div className="text-[11px] text-muted-foreground">Match score</div>
                          <div className="text-base font-semibold text-slate-900">{fitReady.score}</div>
                        </div>
                        <div className="rounded-lg border border-slate-200 bg-white px-3 py-2">
                          <div className="text-[11px] text-muted-foreground">Gate</div>
                          <div className="text-base font-semibold text-slate-900">{fitReady.gateStatus}</div>
                        </div>
                        <div className="rounded-lg border border-slate-200 bg-white px-3 py-2">
                          <div className="text-[11px] text-muted-foreground">Stack match</div>
                          <div className="text-base font-semibold text-slate-900">
                            {fitReady.stackMatch.matched}/{fitReady.stackMatch.total}
                          </div>
                        </div>
                        <div className="rounded-lg border border-slate-200 bg-white px-3 py-2">
                          <div className="text-[11px] text-muted-foreground">Recommendation</div>
                          <div className="text-base font-semibold text-slate-900">{fitReady.recommendation}</div>
                        </div>
                      </div>
                      <div className="text-xs text-slate-600">
                        Gap signals: <span className="font-semibold text-slate-800">{fitReady.topGaps.length}</span>
                      </div>
                      {!fitData?.aiEnhanced && fitData?.aiReason ? (
                        <div className="text-xs text-amber-700">{formatAiReason(fitData.aiReason)}</div>
                      ) : (
                        <div className="text-xs text-muted-foreground">Result source verified.</div>
                      )}
                    </div>
                  ) : null}
                </div>
                {selectedTailorSource ? (
                  <div className="mt-1 flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                    {selectedTailorSource.cv ? (
                      <span className="rounded-full border border-slate-900/10 bg-slate-100/70 px-2 py-0.5">
                        CV: {selectedTailorSource.cv === "ai" ? "AI" : selectedTailorSource.cv === "manual_import" ? "Manual" : "Base"}
                      </span>
                    ) : null}
                    {selectedTailorSource.cover ? (
                      <span className="rounded-full border border-slate-900/10 bg-slate-100/70 px-2 py-0.5">
                        Cover: {selectedTailorSource.cover === "ai" ? "AI" : selectedTailorSource.cover === "manual_import" ? "Manual" : "Fallback"}
                      </span>
                    ) : null}
                  </div>
                ) : null}
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">Select a job to preview details.</div>
            )}
          </div>
          <ScrollArea
            data-testid="jobs-details-scroll"
            data-loading={showLoadingOverlay ? "true" : "false"}
            className={`max-h-full flex-1 min-h-0 transition-opacity duration-200 ease-out ${listOpacityClass}`}
          >
            <div key={effectiveSelectedId ?? "empty"} ref={detailsScrollRef} className="p-4">
            {selectedJob ? (
              <div className="space-y-4 text-sm text-muted-foreground">
                <div className="text-xs uppercase tracking-wide text-muted-foreground">
                  Job Description
                </div>
                {experienceSignals.length ? (
                  <div className="rounded-xl border border-slate-900/10 bg-slate-50/70 p-3">
                    <div className="mb-2 text-[11px] font-semibold uppercase tracking-wide text-slate-700">
                      Experience gate
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {experienceSignals.map((signal) => (
                        <span
                          key={signal.key}
                          className={`inline-flex items-center rounded-full border px-2.5 py-1 text-xs font-medium ${
                            signal.isRequired
                              ? "border-rose-200 bg-rose-50 text-rose-700"
                              : "border-amber-200 bg-amber-50 text-amber-800"
                          }`}
                          title={signal.evidence}
                        >
                          {signal.label}
                        </span>
                      ))}
                    </div>
                  </div>
                ) : null}
                {detailError ? (
                  <div className="rounded-lg border border-destructive/40 bg-destructive/10 p-3 text-sm text-destructive">
                    {detailError}
                  </div>
                ) : null}
                {detailLoading ? (
                  <div className="space-y-3 rounded-lg border border-dashed border-slate-900/10 bg-transparent p-4">
                    <Skeleton className="h-4 w-2/3" />
                    <Skeleton className="h-4 w-5/6" />
                    <Skeleton className="h-4 w-3/4" />
                  </div>
                ) : (
                  <div className="rounded-lg border border-dashed border-slate-900/10 bg-transparent p-5">
                    {selectedDescription ? (
                      <div className="space-y-3">
                        <div
                          className={`relative space-y-4 ${
                            !isExpanded ? "max-h-56 overflow-hidden" : ""
                          }`}
                        >
                          <ReactMarkdown
                            remarkPlugins={[remarkGfm]}
                            rehypePlugins={[rehypeHighlight]}
                            components={{
                              h2: ({ children }) => (
                                <h2 className={markdownStyles.heading}>{renderHighlighted(children)}</h2>
                              ),
                              h3: ({ children }) => (
                                <h3 className={markdownStyles.subheading}>{renderHighlighted(children)}</h3>
                              ),
                              p: ({ children }) => (
                                <p className={markdownStyles.paragraph}>
                                  {renderHighlighted(children)}
                                </p>
                              ),
                              ul: ({ children }) => (
                                <ul className={markdownStyles.list}>{children}</ul>
                              ),
                              ol: ({ children }) => (
                                <ol className={markdownStyles.listOrdered}>{children}</ol>
                              ),
                              li: ({ children }) => (
                                <li className={markdownStyles.listItem}>
                                  {renderHighlighted(children)}
                                </li>
                              ),
                              blockquote: ({ children }) => (
                                <blockquote className={markdownStyles.blockquote}>{children}</blockquote>
                              ),
                              strong: ({ children }) => (
                                <strong className="font-semibold text-slate-900">
                                  {renderHighlighted(children)}
                                </strong>
                              ),
                              a: ({ href, children }) => (
                                <a href={href} className={markdownStyles.link} target="_blank" rel="noreferrer">
                                  {children}
                                </a>
                              ),
                              pre: ({ children }) => <pre className={markdownStyles.pre}>{children}</pre>,
                              code: ({ className, children }) => {
                                const isInline = !className;
                                return isInline ? (
                                  <code className={markdownStyles.codeInline}>{children}</code>
                                ) : (
                                  <code className={className}>{children}</code>
                                );
                              },
                              table: ({ children }) => (
                                <table className={markdownStyles.table}>{children}</table>
                              ),
                              th: ({ children }) => <th className={markdownStyles.th}>{children}</th>,
                              td: ({ children }) => <td className={markdownStyles.td}>{children}</td>,
                            }}
                          >
                            {selectedDescription}
                          </ReactMarkdown>
                          {!isExpanded && isLongDescription ? (
                            <div className="pointer-events-none absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-muted/60 to-transparent" />
                          ) : null}
                        </div>
                        {isLongDescription ? (
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() =>
                              setExpandedDescriptions((prev) => ({
                                ...prev,
                                [selectedJob.id]: !isExpanded,
                              }))
                            }
                          >
                            {isExpanded ? "Show less" : "Show more"}
                          </Button>
                        ) : null}
                      </div>
                    ) : (
                      <div className="text-sm text-muted-foreground">
                        No description available for this job yet.
                      </div>
                    )}
                  </div>
                )}
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">
                Use the list on the left to choose a job.
              </div>
            )}
            </div>
          </ScrollArea>
        </div>
        </section>
      </div>
      </div>
      <AlertDialog
        open={deleteConfirmOpen}
        onOpenChange={(open) => {
          setDeleteConfirmOpen(open);
          if (!open) setDeleteCandidate(null);
        }}
      >
        <AlertDialogContent className="max-w-md rounded-2xl border-slate-200">
          <AlertDialogHeader>
            <AlertDialogTitle>Delete this job?</AlertDialogTitle>
            <AlertDialogDescription>
              This will remove{" "}
              <span className="font-medium text-slate-900">
                {deleteCandidate?.title ?? "this role"}
              </span>{" "}
              from your list. This action cannot be undone.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel className="rounded-xl">Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={confirmDeleteCandidate}
              className="rounded-xl bg-rose-600 text-white hover:bg-rose-700"
            >
              Delete
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
